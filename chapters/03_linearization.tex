% !TeX root = ../main.tex
% Add the above to each chapter to make compiling the PDF easier in some editors.

\chapter{Linearizing MRBNFs}
\label{chapter:linearizing}

\section{Linearizing MRBNFs}
  In this section we define the linearization of a \ac{MRBNF} $F$ on a subset of it's \textit{live} variables. Linearization means, that the resulting type only contains elements for which all atoms of the linearized variables are distinct. We say $F$ is \textit{non-repetitive} on these variables. This type is also a \ac{MRBNF} with the same variable types (\textit{live}, \textit{free}, \textit{bound}, \textit{dead}), except for the linearized variables that change their type from \textit{live} to \textit{bound}. This means that the new map function is restricted to only allow bijective and small-support functions on these variables. 

  We formalize the idea of distinctness of components as \textit{non-repetitiveness} on the linearized variables. In our notation we use $\lin \leq l$ to refer to the number of linearized variables. Furthermore, we assume the variables that we linearize on to be the the \textit{last} $\lin$ of the live variables. Consequently, the first $l' = l - \lin$ lives of $F$ are not linearized.

  \subsection{Non-repetitiveness}
  \label{subsec:nonrep}
    At the core of linearization lies the notion of \textit{non-repetitiveness}. An element $x$ of a type is considered to be non-repetitive with respect to a type variable $\alpha$ if it does not contain repeating $\alpha$-atoms. For example, a \type{$\alpha$ list} is non-repetitive, if all of its $\alpha$-elements it contains are pairwise distinct. 
    To define non-repetitiveness for an arbitrary \ac{MRBNF}, we have to express this property in terms of its map, set and relator functions. Considering \type{$\alpha$ list}s again, we can show a list $xs$ to be distinct, iff for each other list $ys$ of the same length, we can find a function $f$ such that $ys = \map_\textsf{list}\; f\; xs$. If $xs$ were not distinct, there must exist two indices with the same $\alpha$ element in $xs$. Furthermore, there exists a $ys$ that has different elements at these two indices and thus a function mapping $xs$ to $ys$ cannot exist, since it would have to map two same elements in $xs$ to two differing ones in $ys$. 

    In \autoref{subsubsec:Rel} we proposed the idea to think about elements of a \ac{BNF} (or \ac{MRBNF}) $F$ as containers with a certain shape with atoms in slots specified by the shape. Using this model, we can generalize the notion of lists having the same length to $F$ elements having the same shape. We can express this through the relator by using the $\top$ relation that relates everything with each other as the argument. Thus, we give the definition of equivalent shape and non-repetitiveness for list:
    \begin{align*}
      \eqshape_\textsf{list}\; x\; y &= \rel_\textsf{list}\; \top\; x\; y\\
      \nonrep_\textsf{list}\; x &= \forall y.\; \eqshape_\textsf{list}\; x\; y \Longrightarrow (\exists f.\; y = \map_\textsf{list}\; f\; x)
    \end{align*}

    Note that we use the regular relator that only relates live variables with given relations while it requires equality for all frees and bounds. 

    Based on this, $x$ is a non-repetitive element, if for all other elements $y$ with equal shape, a function exists through which $x$ can be mapped to $y$. In our example of \type{list}, this holds for all lists with distinct elements (given a second list, one can easily define a function mapping the distinct elements of $x$ to that list). It does not hold for lists with repeating elements, because no $f$ exists that could map two equal elements at different positions in this list to distinct elements in an arbitrary second list.

    More interesting is the case of \type{($\alpha$, $\beta$) alist} which we only want to be non-repetitive on $\alpha$. For our purpose of defining non-repetitiveness on a subset of the live variables, we fix the other live variables to be equal when defining equivalent shape. For \acp{MRBNF} with more than one live variable, we can give a definitions of \textit{non-repetitiveness} and having \textit{equal shape} on the last $\lin$ live variables. In that case, we consider $x$ and $y$ of type $F$ to have equal shape with respect to the variables $\alpha_{l'+1} \dots \alpha_\lin$, iff they are \textit{equal} in the atoms corresponding to the non linearized lives and are related with $\top$ in on the linearized variables. Consequently for the map in the $\nonrep$ definition, the $\id$ function is applied to the non linearized lives, since they are already required to be equal. 
    \begin{align*}
      \eqshape_F^\lin\; x\; y &= \rel_F\; \langle (=)^{l'} (\top)^\lin \rangle\; x\; y\\
      \nonrep_F^\lin\; x &= \forall y.\; \eqshape_F^\lin\; x\; y \Longrightarrow (\exists f^\lin.\; y = \map_F\; \langle\id^{l'} f^\lin \rangle\; \id^\fr\; \id^b\; x)
    \end{align*}

    Note, that we use $\langle \dots \rangle$ to indicate arguments that belong together, e.g., that they are both live. They are just inserted to improve readability

  \subsection{Conditions for linearization}
  \label{subsec:conditions}
    A \acp{MRBNF} has to fulfill two properties to be linearized. First, to ensure that the resulting type constructor is non-empty, it is required, that there exists a non-repetitive element (with respect to the linearized variables): $\exists x.\; \nonrep\; x$

    Furthermore, even though \acp{MRBNF} are already required to preserve weak pullbacks defined as \ref{eq:in_rel} in \autoref{fig:bnf_axioms}, for the linearization it is required that they preserve \textit{all} pullbacks. Formalized this means that the existence of $z$ in the equation has to be fulfilled uniquely, i.e., for each $R$-related $x$ and $y$ there exists \textit{exactly one} $z$ fulfilling the property \ref{eq:in_rel}. For example the strong pullback preservation is fulfilled by the \type{$\alpha$ list} and \type{$\alpha$ $\beta$ prod} functor but not by \type{$\alpha$ fset}, the type constructor for finite sets of $\alpha$s. 
    \begin{align*}
      \rel_F\; R^l\; x\; y =\; &\exists!z.\; (\forall i.\; \set_{F,i}\; z \subseteq \{(a, b).\; R_i\; a\; b \})\; \land \tag{\textsc{PB\_strong}}\label{eq:PB_strong}\\
      &\smash{\map_F\; \fst^l\; \id^\fr\; \id^b\; z = x \land \map_F\; \snd^l\; \id^\fr\; \id^b\; z = y}
    \end{align*}

    We note here that the requirement of strong pullback preservation can be omitted, when the \ac{MRBNF} is linearized on all its live variables, i.e., when the linearized \ac{MRBNF} has no live variables. This is because in this case the \ref{eq:rel_exchange} lemma explained in Subsection~\ref{par:rel_exchange} becomes trivial. In all other cases, that lemma is the sole reason, strong pullback preservation is required.

  \subsection{Intermediate lemmas}
    We want to prove the \ac{MRBNF} axioms for the linearized \ac{MRBNF}. For this we utilize some intermediate lemmas which we present in this section.
    
    \subsubsection{F is strong}
      From the pullback preservation with uniqueness we can prove the following lemma. In fact this notion of strength is equivalent to pullback preservation: 
      \begin{equation*}
        \rel_F\; R^l\; x\; y\; \land\; \rel_F\; Q^l\; x\; y \Longrightarrow \rel_F\; (\inf\; R\; Q)^l\; x\; y \tag{\textsc{F\_strong}}\label{eq:F_strong}
      \end{equation*} 
      where the infimum $\inf$ of two relations $R$ and $Q$ relates exactly those elements that are related by both $R$ and $Q$. 

    \subsubsection{Relation exchange}
    \label{par:rel_exchange}
      The \textit{exchange of relations} is a consequence of the previous property, \ref{eq:F_strong}: If two elements $x$ and $y$ are related through the relator with two different lists $R^l = R_1 \dots R_l$ and $Q^l = Q_1 \dots Q_l$ of atom-level relations, then $x$ and $y$ are also related with any index-wise combination of $R^l$ or $Q^l$. For each index $i$ either the relation $R_i$ or $Q_i$ is selected. 
      
      For our purpose of linearization, we are specifically interested in the case, where for all live variables that we linearize on the relation from $R^l$ is chosen and for all others the relation from $Q^l$ relation, i.e., $Q^{l'}\; R^\lin$. This results in the following lemma for a \ac{MRBNF} $F$:
      \begin{equation*}
        \rel_F\; R^l\; x\; y\; \land\; \rel_F\; Q^l\; x\; y \Longrightarrow \rel_F\; \langle Q^{l'} R^\lin \rangle\; x\; y \tag{\textsc{rel\_exchange}}\label{eq:rel_exchange}
      \end{equation*} 
      In the specific case, that the \ac{MRBNF} is linearized on \textit{all} of it's live variables, $l' = 0$ and $\lin = l$ resulting in $R^l$ as the combination that is chosen. Then the lemma becomes trivial, since its goal is equal to it's first assumption in this case.

      As a consequence of this, the previous lemma \ref{eq:F_strong} is not needed to prove this lemma. Furthermore, this lemma is the sole reason why \ref{eq:F_strong} and strong pullback preservation are needed for the linearization. Thus the requirement of pullback preservation can be lifted, in the case that the linearization is applied to all live variables at the same time.

    \subsubsection{map peresrving non-repetitiveness}
      \begin{align*}
        &\textsf{small\_supp}\; v^\fr\; \land\; \textsf{small\_supp}\; u^b\; \land\; \textsf{bijective}\; u^b\; \land \tag{\textsc{nonrep\_map}}\label{eq:nrp_map}\\
        &\textsf{bijective}\; f^\lin\; \land\; \nonrep_F^\lin\; x\; \Longrightarrow \nonrep_F^\lin\; (\map_F\; \langle g^{l'} f^\lin \rangle\; v^\fr\; u^b\; x)
      \end{align*} 

    
    \subsubsection{map reflecting non-repetitiveness}
      reverse \ref{eq:nrp_map}
      \begin{equation*}
        \nonrep_F^\lin\; (\map_F\; \langle f^{l'} \id^\lin \rangle\; \id^\fr\; \id^b\; x)\Longrightarrow \nonrep_F^\lin\; x \tag{\textsc{nonrep\_map\_rev}}\label{eq:nrp_map_rev}
      \end{equation*} 

    \subsection{Defining the subtype and its constants}
      Using our definition of non-repetitiveness, we carve out a subtype of $F$ using Isabelle's \textbf{typedef} command. This subtype $F'$ contains exactly those elements from $F$ that are non-repetitive on the linearized variables $\alpha_{l'+1} \dots \alpha_\lin$. It furthermore provides us with the morphisms $\rep_{F'}$ to convert $F'$ elements to the type $F$ and $\abs_{F'}$ to convert $F$ elements to $F'$ - provided that they are non-repetitive.

      In the following we specify the \ac{MRBNF} constants, i.e., the mapper, setters, bound and relator for $F'$. We define these in terms of the base types constants and apply the morphisms to match the types: The setters stay unchanged and thus we can keep the same bound. For the relator the relations for the linearized lives are fixed to the equality relation, since in the new \ac{MRBNF} these will be bounds. Lastly, for the mapper we only allow it to map bijective functions on the linearized variables in addition to the restrictions for the existing frees and bounds. This restriction is necessary to ensure that applying the map function to a $F'$ element preserves it non-repetitiveness. If a function that violates any of the restrictions is given to the mapper, it is ignored and not applied.

      As for the morphisms, concretely, we apply $\rep_{F'}$ to the $F'$ arguments of the new mapper, setters and relator, and $\abs_{F'}$ to the result of the mapper. This leads us to the following definitions:
      \begin{align*}
        \set_{F',i} &= \set_{F,i} \circ \rep_{F'}\\
        \map_{F'}\; (f^{l'}\; g^\lin)\; u^\fr\; v^b &= \abs_{F'} \circ (\map_{F}\; (f^{l'}\; (\asBij\; g)^\lin)\; v^\fr\; u^b ) \circ \rep_{F'}\\
        \rel_{F'}\; R^{l'}\; x\; y &= \rel_{F}\; (R^{l'}\; (=)^\lin)\; (\rep_{F'}\; x)\; (\rep_{F'}\; y)
      \end{align*}
      where $\asBij f = \texttt{if}\; \textsf{bijective}\; f\; \texttt{then}\; f\; \texttt{else}\; \id$.
      We note here, that in our implementation in Isabelle/HOL, we also enforce the $u^b$ to be bijective using $\asBij$ and both $v^\fr$ and $u^b$ to be small-support functions using an analogously defined $\asSS$. We omit this here as we assume $\map_{F}$ to handle these cases.
      
    \subsection{Proving the MRBNF axioms}
      To show that $F'$ is a \ac{MRBNF}, we have to prove the axioms from \autoref{fig:bnf_axioms} for it. 
      For most of the axioms this is straight forward for most of the axioms, as they only require unfolding the definitions of the new $F'$ constants, applying the axioms of the original $F$ and a few simple transformations. The axioms \ref{eq:map_id}, \ref{eq:map_cong} and \ref{eq:set_bd} are proven this way, while \ref{eq:map_comp} and \ref{eq:set_map} require just a little more effort. Both contain the composition of $\map_{F'}$ or $\set_{F'}$ with $\map_{F'}$, respectively. 
      
      As an example we show \ref{eq:set_map} for $F'$ below. Note that we assume $i$ to be in the range $1 \leq i \leq v\!s$ where $v\!s$ is the number of all non-dead type variables, i.e., $v\!s = l + \fr + b$. The proof works the same for setters of frees and bounds. Furthermore we assume all functions $f^{v!s}$ fulfilling their respective requirements (bijectivity and small-support) and thus all $\asBij$ and $\asSS$ evaluating to the \texttt{then} case.
      \begin{align*}
        &\set_{F',i}\; (\map_{F'}\; f^{v\!s}\; x) \\
        \equiv\; &\set_{F,i} \circ \rep_{F'}\; ((\abs_{F'} \circ (\map_{F}\; f^{v\!s}) \circ \rep_{F'})\; x)& \text{unfold defs}\\
        \equiv\; &\set_{F,i}\; (\rep_{F'}\; (\abs_{F'}\; (\map_{F}\; f^{v\!s}\; (\rep_{F'}\; x))))& \text{$\circ$ application}\\
        \equiv\; &\nonrep_F^\lin\; (\map_{F}\; f^{v\!s}\; (\rep_{F'}\; x)) \Longrightarrow\set_{F,i}\; (\map_{F}\; f^{v\!s}\; (\rep_{F'}\; x))& \text{$\abs$ inverse}\\
        \equiv\; &\nonrep_F^\lin\; (\rep_{F'}\; x) \Longrightarrow\set_{F,i}\; (\map_{F}\; f^{v\!s}\; (\rep_{F'}\; x))& \text{\ref{eq:nrp_map}}\\
        \equiv\; &\set_{F,i}\; (\map_{F}\; f^{v\!s}\; (\rep_{F'}\; x))& \text{$\nonrep\; \rep_{F'}$}\\
        \equiv\; &f_i\; \grave{\phantom{\_}}\; \set_{F,i}\; (\rep_{F'}\; x)& \text{\ref{eq:set_map} of $F$}\\
        \equiv\; &f_i\; \grave{\phantom{\_}}\; \set_{F',i}\; x & \text{fold defs, $\circ$}
      \end{align*}
      where "$\abs$ inverse" denotes the theorem that $\rep_{F'}$ is the inverse of $\abs_{F'}$ for arguments that are non-repetitive. Furthermore "$\nonrep\; \rep_{F'}$" states that converting a $F'$ element to $F$ inherently means that the $F$ element is non-repetitive.
      
      The validity of the bound \ref{eq:bd} is trivially proven, since the bound is copied from $F$.

      It remains to show \ref{eq:rel_compp} and \ref{eq:in_rel} for $F'$. While the former is easily proven using the corresponding axiom of $F$ and some simple properties of relational composition, the latter is certainly the most interesting axiom to show. 
      
      We don't show a full proof of this property here, but investigate an interesting step. In the proof we reach a state, where we need to show that $\nonrep_F^\lin\; (\map_F\; \fst^l\; \id^\fr\; \id^b\; z) \Longrightarrow \nonrep_F^\lin\; (\map_F\; \langle\id^{l'} \fst^\lin \rangle\; \id^\fr\; \id^b\; z)$. To give an intuition for why this is necessary, we obtain the left side of the implication from the \ref{eq:in_rel} axiom of $F$ and need to show the right side to eliminate a composition $\abs_{F'} \circ \rep_{F'}$ in the goal state. 

      \begin{align*}
        &\nonrep_F^\lin\; (\map_F\; \fst^l\; \id^\fr\; \id^b\; z) \Longrightarrow\\
        &\nonrep_F^\lin\; (\map_F\; \langle \fst^{l'} \id^\lin \rangle\; \id^\fr\; \id^b\; (\map_F\; \langle \id^{l'} \fst^\lin \rangle\; \id^\fr\; \id^b\; z)) \Longrightarrow\\
        &\nonrep_F^\lin\; (\map_F\; \langle \id^{l'} \fst^\lin\rangle\; \id^\fr\; \id^b\; z)\\
      \end{align*}

      The first step is reached through \ref{eq:map_comp} of $F$, while the second one needs the \ref{eq:nrp_map_rev} lemma. This is the final place, where strong pullback preservation is used and the reason why it is required.

      Another interesting step in the proof of \ref{eq:in_rel} is the conversion from $\mrrel_{F'}$ to $\mrrel_F$. While $\mrrel_{F'}$ takes functions for the linearized type variables - that turned to bounds, the relator of original \ac{MRBNF} $F$ takes relations for these. By explicitly specifying 
      % TODO: maybe
      \begin{align*}
      &\mrrel_{F'}\; f^\lin\; v^\fr\; u^b\; R^{l'}\; x\; y =\\
      &\rel_{F'}\; R^{l'}\; (\map_{F'}\; (\id^{l'}\; f^\lin)\; v^\fr\; u^b\; x)\; y =\\
      &\rel_F\; \langle R^{l'} (=)^\lin \rangle\; (\map_F\; \langle \id^{l'} f^\lin \rangle\; v^\fr\; u^b\; x)\; y =\\
      &\rel_F\; \langle R^{l'} (\Grp f)^\lin \rangle\; (\map_F\; \id^l\; v^\fr\; u^b\; x)\; y =\\
      &\mrrel_F\; v^\fr\; u^b\; (R^{l'}\; (\Grp f)^\lin)\; x\; y
      \end{align*}

    \subsection{Lifting Witnesses}
    \label{subsec:lin_wits}
      Existing witnesses of the original \ac{MRBNF} that do not depend on any of the linearized variables can be lifted to be witnesses of the linearized \ac{MRBNF}. 

      For this it is necessary to show that they are non-repetitive on the linearized elements, i.e., that they are part of the new type. From \ref{eq:wits} (\autoref{subsec:bnf_wits}) we know that any witness not depending on the linearized lives does not contain atoms from these lives. Thus, we can show that these witnesses are non-repetitive, since an element with no $\alpha$ atoms is trivially non-repetitive on $\alpha$.

      Other witnesses that depend on the linearized variables cannot be lifted and have to be discarded. Even if they are non-repetitive, witnesses of a \ac{MRBNF} may only depend on lives and not on bounds, which the linearized lives turn into. 

      Additionally, new witnesses may be specified for the resulting \ac{MRBNF}. For these the property \ref{eq:wits} defined in \autoref{subsec:bnf_wits} has to be proven, i.e., that they only consist of the atoms given to them as arguments.

      When an liftable witness of the original \ac{MRBNF} exists or a new witness fulfilling \ref{eq:wits} is specified, the existence of a non-repetitive element we motivated in \autoref{subsec:conditions} is trivially proven.

    \subsection{Preservation of strength}
      

  \section{Implementing the \textbf{linearize\_mrbnf} command}
    We implement a command that allows the user to linearize an existing \ac{MRBNF} or \ac{BNF} on one or multiple of it's live variables. The syntax of the command is given in the following:

    \input{figures/linearize_rail.tex}

    With this command, we can linearize our example by writing the following line in Isabelle:
    \begin{equation*}
      \textbf{linearize\_mrbnf}\; (\text{keys:}\; \alpha :: \text{var},\; \text{vals:}\; \beta)\; \text{alist} = (\alpha :: \text{var} \times \beta)\; \text{list}\; \textbf{on}\; \alpha
    \end{equation*}
    Since for \type{$(\alpha \times \beta)$ list} both type variables are live and we only linearize on $\alpha$, it is necessary to prove strong pullback preservation for this \ac{MRBNF}. 

    After the user has written the command, the conditions for linearization we presented in~\autoref{subsec:conditions} have to be proven, i.e., non-emptiness of the linear type and strong pullback preservation. 
    
    These conditions are given dynamically to the user. For example, it is only necessary to show strong pullback preservation \ref{eq:PB_strong}, when the resulting \ac{MRBNF} has live variables remaining. Furthermore, as mentioned in \autoref{subsec:lin_wits}, the non-emptiness of the non-repetitive type is easily proven when the user specified a non-emptiness witness, or a liftable witness of the original type exists. Thus, the user is not asked to show the existence of a non-repetitive element in these cases.

    Furthermore, since the original \ac{MRBNF} already fulfills weak pullback preservation, we extract the uniqueness property of strong pullback preservation and require the user to prove only this. Strong pullback preservation \ref{eq:PB_strong} can be proven from weak pullback preservation \ref{eq:in_rel} together with the uniqueness property we specify as follows:
    \begin{align*}
      \forall x\; y.\; (&\map_F\; \fst^l\; \id^\fr\; \id^b\; x = \map_F\; \fst^l\; \id^\fr\; \id^b\; y\; \land\\
      &\map_F\; \snd^l\; \id^\fr\; \id^b\; x = \map_F\; \snd^l\; \id^\fr\; \id^b\; y)\Longrightarrow\\ 
      &x = y
    \end{align*}

    
    

    
    % TODO: Implementation in Isabelle (theorem names, definitions)
    % resulting MRBNF is also "strong" (preserves all pullbacks)

  